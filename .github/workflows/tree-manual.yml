name: Generate Project Tree (Manual)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install tree
        run: sudo apt-get update && sudo apt-get install -y tree

      - name: Generate tree
        run: |
          tree -d -I ".git|.venv|__pycache__" > TREE.txt

      - name: Update README
        run: |
          python << 'EOF'
          from pathlib import Path

          readme = Path("README.md").read_text()
          tree = Path("TREE.txt").read_text()

          start = "<!-- TREE START -->"
          end = "<!-- TREE END -->"

          before, rest = readme.split(start)
          _, after = rest.split(end)

          new_block = f"""{start}
          ```text
          {tree.strip()}
          ```
          {end}"""

          Path("README.md").write_text(before + new_block + after)
          EOF

      - name: Commit README
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions@github.com"
          git add README.md
          git commit -m "docs: generate project tree" || exit 0
          git push
